name: Deploy with Self-Hosted Runner

# ÈÉ®ÁΩ≤ËßÑÂàôÔºö
# - Push Âà∞ main ÂàÜÊîØ ‚Üí 31.66 ÊµãËØïÁéØÂ¢É (Êú¨Âú∞ÊûÑÂª∫Ôºå‰∏ç push)
# - Release ÂèëÂ∏É ‚Üí 31.65 Áîü‰∫ßÁéØÂ¢É (ÊûÑÂª∫Âπ∂ push Âà∞ ghcr.io)

on:
  release:
    types: [published]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment target'
        required: true
        default: 'alpha'
        type: choice
        options:
          - prod
          - alpha

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ÊµãËØïÁéØÂ¢ÉÈÉ®ÁΩ≤ (31.66) - Êú¨Âú∞ÊûÑÂª∫Ôºå‰∏ç push Âà∞ ghcr.io
  deploy-alpha:
    name: Deploy to Test (31.66)
    if: |
      github.repository == 't0ken-ai/MemoryX' &&
      (github.event_name == 'push' || 
       (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'alpha'))
    runs-on: t0ken-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and deploy
        run: |
          echo "üß™ Building and deploying to test environment (31.66)..."
          
          # Áõ¥Êé•‰ΩøÁî® docker buildÔºàÁÆÄÂçïÂèØÈù†Ôºâ
          docker build -f Dockerfile.api -t memoryx-api:test .
          
          # ÂÅúÊ≠¢ÊóßÂÆπÂô®
          docker stop memoryx-api 2>/dev/null || true
          docker rm memoryx-api 2>/dev/null || true
          
          # Êõ¥Êñ∞ÈùôÊÄÅÊñá‰ª∂
          cp -r static/* /data/memoryx/static/
          
          # ÂêØÂä®Êñ∞ÂÆπÂô®
          docker run -d \
            --name memoryx-api \
            --restart=unless-stopped \
            --network host \
            -v /data/memoryx/static:/app/static:ro \
            -v /etc/memoryx/api.env:/app/.env:ro \
            -e DATABASE_URL=postgresql://memoryx:memoryx123@localhost:5432/memoryx \
            -e REDIS_URL=redis://localhost:6379/0 \
            -e SECRET_KEY=${{ secrets.API_SECRET_KEY }} \
            -e APP_NAME=MemoryX_Test \
            -e DEBUG=false \
            memoryx-api:test
          
          # ÂÅ•Â∫∑Ê£ÄÊü•
          echo "‚è≥ Waiting for health check..."
          sleep 10
          
          for i in {1..5}; do
            if curl -s http://localhost:8000/api/health | grep -q "healthy"; then
              echo "‚úÖ Deployment successful! API is healthy"
              exit 0
            fi
            echo "‚è≥ Retry \$i/5..."
            sleep 5
          done
          
          echo "‚ùå Health check failed"
          docker logs memoryx-api --tail 20
          exit 1

  # Áîü‰∫ßÁéØÂ¢ÉÈÉ®ÁΩ≤ (31.65) - ÊûÑÂª∫Âπ∂ push Âà∞ ghcr.io
  deploy-prod:
    name: Deploy to Production (31.65)
    if: |
      github.repository == 't0ken-ai/MemoryX' &&
      (github.event_name == 'release' || 
       (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'))
    runs-on: t0ken-prod
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name || github.ref }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.api
          push: true
          tags: |
            ghcr.io/t0ken-ai/memoryx:sha-${{ github.sha }}
            ghcr.io/t0ken-ai/memoryx:${{ github.event.release.tag_name || 'latest' }}
            ghcr.io/t0ken-ai/memoryx:release
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to Production Server
        run: |
          echo "üöÄ Deploying to production environment (31.65)..."
          
          docker stop memoryx-api 2>/dev/null || true
          docker rm memoryx-api 2>/dev/null || true
          
          docker pull ghcr.io/t0ken-ai/memoryx:sha-${{ github.sha }}
          
          cp -r static/* /data/memoryx/static/
          
          docker run -d \
            --name memoryx-api \
            --restart=unless-stopped \
            --network host \
            -v /data/memoryx/static:/app/static:ro \
            -v /etc/memoryx/api.env:/app/.env:ro \
            ghcr.io/t0ken-ai/memoryx:sha-${{ github.sha }}
          
          echo "‚è≥ Waiting for health check..."
          sleep 10
          
          for i in {1..5}; do
            if curl -s http://localhost:8000/api/health | grep -q "healthy"; then
              echo "‚úÖ Deployment successful!"
              exit 0
            fi
            echo "‚è≥ Retry \$i/5..."
            sleep 5
          done
          
          echo "‚ùå Health check failed"
          docker logs memoryx-api --tail 20
          exit 1
