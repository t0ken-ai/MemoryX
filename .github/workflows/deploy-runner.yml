name: Deploy with Self-Hosted Runner

# éƒ¨ç½²è§„åˆ™ï¼š
# - Push åˆ° main åˆ†æ”¯ â†’ 31.66 æµ‹è¯•ç¯å¢ƒ (æœ¬åœ°æ„å»ºï¼Œä¸ push)
# - Release å‘å¸ƒ â†’ 31.65 ç”Ÿäº§ç¯å¢ƒ (æ„å»ºå¹¶ push åˆ° ghcr.io)

on:
  release:
    types: [published]
  push:
    branches: [main]
    paths:
      - 'static/**'
      - 'api/**'
      - 'Dockerfile.api'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment target'
        required: true
        default: 'alpha'
        type: choice
        options:
          - prod
          - alpha

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # æµ‹è¯•ç¯å¢ƒéƒ¨ç½² (31.66) - æœ¬åœ°æ„å»ºï¼Œä¸ push åˆ° ghcr.io
  deploy-alpha:
    name: Deploy to Test (31.66)
    # Push åˆ° main åˆ†æ”¯æ—¶è§¦å‘ï¼Œæˆ–æ‰‹åŠ¨é€‰æ‹© alpha
    if: |
      github.repository == 't0ken-ai/MemoryX' &&
      (github.event_name == 'push' || 
       (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'alpha'))
    runs-on: t0ken-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (local only)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.api
          push: false  # ä¸ push åˆ° ghcr.io
          tags: memoryx-api:local
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/memoryx-api.tar

      - name: Load and deploy to Test Server
        run: |
          echo "ğŸ§ª Deploying to test environment (31.66)..."
          
          # åŠ è½½æ„å»ºå¥½çš„é•œåƒ
          docker load -i /tmp/memoryx-api.tar
          docker tag memoryx-api:local memoryx-api:test
          
          # åœæ­¢æ—§å®¹å™¨
          docker stop memoryx-api 2>/dev/null || true
          docker rm memoryx-api 2>/dev/null || true
          
          # æ›´æ–°é™æ€æ–‡ä»¶
          cp -r ${{ github.workspace }}/static/* /data/memoryx/static/
          
          # å¯åŠ¨æ–°å®¹å™¨
          docker run -d \
            --name memoryx-api \
            --restart=unless-stopped \
            --network host \
            -v /data/memoryx/static:/app/static:ro \
            -v /etc/memoryx/api.env:/app/.env:ro \
            -e DATABASE_URL=postgresql://memoryx:memoryx123@localhost:5432/memoryx \
            -e REDIS_URL=redis://localhost:6379/0 \
            -e SECRET_KEY=${{ secrets.API_SECRET_KEY }} \
            -e APP_NAME=MemoryX_Test \
            -e DEBUG=false \
            memoryx-api:test
          
          # å¥åº·æ£€æŸ¥
          echo "â³ Waiting for health check..."
          sleep 10
          
          for i in {1..5}; do
            if curl -s http://localhost:8000/api/health | grep -q "healthy"; then
              echo "âœ… Deployment successful! API is healthy"
              exit 0
            fi
            echo "â³ Retry $i/5..."
            sleep 5
          done
          
          echo "âŒ Health check failed"
          docker logs memoryx-api --tail 20
          exit 1

  # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² (31.65) - æ„å»ºå¹¶ push åˆ° ghcr.io
  deploy-prod:
    name: Deploy to Production (31.65)
    # Release å‘å¸ƒæ—¶è§¦å‘ï¼Œæˆ–æ‰‹åŠ¨é€‰æ‹© prod
    if: |
      github.repository == 't0ken-ai/MemoryX' &&
      (github.event_name == 'release' || 
       (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'))
    runs-on: t0ken-prod
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name || github.ref }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.api
          push: true  # æ¨é€åˆ° ghcr.io
          tags: |
            ghcr.io/${{ github.repository }}:sha-${{ github.sha }}
            ghcr.io/${{ github.repository }}:${{ github.event.release.tag_name || 'latest' }}
            ghcr.io/${{ github.repository }}:release
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to Production Server
        run: |
          echo "ğŸš€ Deploying to production environment (31.65)..."
          
          # åœæ­¢æ—§å®¹å™¨
          docker stop memoryx-api 2>/dev/null || true
          docker rm memoryx-api 2>/dev/null || true
          
          # æ‹‰å–æ–°é•œåƒ
          docker pull ghcr.io/${{ github.repository }}:sha-${{ github.sha }}
          
          # æ›´æ–°é™æ€æ–‡ä»¶
          cp -r ${{ github.workspace }}/static/* /data/memoryx/static/
          
          # å¯åŠ¨æ–°å®¹å™¨
          docker run -d \
            --name memoryx-api \
            --restart=unless-stopped \
            --network host \
            -v /data/memoryx/static:/app/static:ro \
            -v /etc/memoryx/api.env:/app/.env:ro \
            ghcr.io/${{ github.repository }}:sha-${{ github.sha }}
          
          # å¥åº·æ£€æŸ¥
          echo "â³ Waiting for health check..."
          sleep 10
          
          for i in {1..5}; do
            if curl -s http://localhost:8000/api/health | grep -q "healthy"; then
              echo "âœ… Deployment successful! API is healthy"
              exit 0
            fi
            echo "â³ Retry $i/5..."
            sleep 5
          done
          
          echo "âŒ Health check failed"
          docker logs memoryx-api --tail 20
          exit 1
