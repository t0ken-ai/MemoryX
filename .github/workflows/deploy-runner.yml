name: Deploy with Self-Hosted Runner

# Security: Only run on main repo, not forks
# This prevents malicious code from forks running on self-hosted runners

on:
  release:
    types: [published]
  push:
    branches: [main]
    paths:
      - 'static/**'
      - 'api/**'
      - 'Dockerfile.api'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment target'
        required: true
        default: 'alpha'
        type: choice
        options:
          - prod
          - alpha

# Prevent running on forks
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # æµ‹è¯•ç¯å¢ƒéƒ¨ç½² (31.66) - ä½¿ç”¨ t0ken-test runner
  deploy-alpha:
    name: Deploy to Test (31.66)
    # Only run on main repo and correct events
    if: github.repository == 't0ken-ai/MemoryX'
    # Note: Environment approval can be enabled in GitHub settings
    # environment: alpha
    runs-on: t0ken-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.api
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:sha-${{ github.sha }}
            ghcr.io/${{ github.repository }}:alpha
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to Test Server
        run: |
          echo "ğŸ§ª Deploying to test environment (31.66)..."
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export IMAGE_TAG=sha-${{ github.sha }}
          export DEPLOY_TYPE=alpha
          
          # åœæ­¢æ—§å®¹å™¨
          docker stop memoryx-api 2>/dev/null || true
          docker rm memoryx-api 2>/dev/null || true
          
          # æ‹‰å–æ–°é•œåƒ
          docker pull ghcr.io/${{ github.repository }}:sha-${{ github.sha }}
          
          # æ›´æ–°é™æ€æ–‡ä»¶
          cp -r ${{ github.workspace }}/static/* /data/memoryx/static/
          
          # å¯åŠ¨æ–°å®¹å™¨
          docker run -d \
            --name memoryx-api \
            --restart=unless-stopped \
            --network host \
            -v /data/memoryx/static:/app/static:ro \
            -v /etc/memoryx/api.env:/app/.env:ro \
            -e DATABASE_URL=postgresql://memoryx:memoryx123@localhost:5432/memoryx \
            -e REDIS_URL=redis://localhost:6379/0 \
            -e SECRET_KEY=${{ secrets.API_SECRET_KEY }} \
            -e APP_NAME=MemoryX_Test \
            -e DEBUG=false \
            ghcr.io/${{ github.repository }}:sha-${{ github.sha }}
          
          # å¥åº·æ£€æŸ¥
          echo "â³ Waiting for health check..."
          sleep 10
          
          for i in {1..5}; do
            if curl -s http://localhost:8000/api/health | grep -q "healthy"; then
              echo "âœ… Deployment successful! API is healthy"
              exit 0
            fi
            echo "â³ Retry $i/5..."
            sleep 5
          done
          
          echo "âŒ Health check failed"
          docker logs memoryx-api --tail 20
          exit 1

  # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² (31.65) - ä½¿ç”¨ t0ken-prod runner
  deploy-prod:
    name: Deploy to Production (31.65)
    # Only run on main repo
    if: github.repository == 't0ken-ai/MemoryX'
    # Note: Environment approval can be enabled in GitHub settings for production
    # environment: production
    runs-on: t0ken-prod
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name || github.ref }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.api
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:sha-${{ github.sha }}
            ghcr.io/${{ github.repository }}:${{ github.event.release.tag_name || 'latest' }}
            ghcr.io/${{ github.repository }}:release
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to Production Server
        run: |
          echo "ğŸš€ Deploying to production environment (31.65)..."
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export IMAGE_TAG=sha-${{ github.sha }}
          export DEPLOY_TYPE=release
          
          # åœæ­¢æ—§å®¹å™¨
          docker stop memoryx-api 2>/dev/null || true
          docker rm memoryx-api 2>/dev/null || true
          
          # æ‹‰å–æ–°é•œåƒ
          docker pull ghcr.io/${{ github.repository }}:sha-${{ github.sha }}
          
          # æ›´æ–°é™æ€æ–‡ä»¶
          cp -r ${{ github.workspace }}/static/* /data/memoryx/static/
          
          # å¯åŠ¨æ–°å®¹å™¨ (ç”Ÿäº§ç¯å¢ƒé…ç½®)
          docker run -d \
            --name memoryx-api \
            --restart=unless-stopped \
            --network host \
            -v /data/memoryx/static:/app/static:ro \
            -v /etc/memoryx/api.env:/app/.env:ro \
            ghcr.io/${{ github.repository }}:sha-${{ github.sha }}
          
          # å¥åº·æ£€æŸ¥
          echo "â³ Waiting for health check..."
          sleep 10
          
          for i in {1..5}; do
            if curl -s http://localhost:8000/api/health | grep -q "healthy"; then
              echo "âœ… Deployment successful! API is healthy"
              exit 0
            fi
            echo "â³ Retry $i/5..."
            sleep 5
          done
          
          echo "âŒ Health check failed"
          docker logs memoryx-api --tail 20
          exit 1
