name: Deploy Static Files

on:
  push:
    branches: [main]
    paths:
      - 'static/**'
  workflow_dispatch:

# æ³¨æ„ï¼š31.65/31.66 æ˜¯å†…ç½‘ï¼ŒGitHub Actions æ— æ³•ç›´æ¥è®¿é—®
# æ›¿ä»£æ–¹æ¡ˆï¼š
# 1. ä½¿ç”¨è‡ªæ‰˜ç®¡ Runnerï¼ˆæ¨èï¼‰
# 2. Webhook + æœåŠ¡å™¨æœ¬åœ°è„šæœ¬æ‹‰å–
# 3. æ‰‹åŠ¨éƒ¨ç½²

jobs:
  # æ–¹æ¡ˆ 1: è‡ªæ‰˜ç®¡ Runnerï¼ˆéœ€è¦åœ¨ 31.65/31.66 ä¸Šå®‰è£… GitHub Runnerï¼‰
  deploy-self-hosted:
    name: Deploy via Self-Hosted Runner
    runs-on: self-hosted  # éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šé…ç½® runner
    if: false  # æš‚æ—¶ç¦ç”¨ï¼Œç›´åˆ°é…ç½®å¥½ runner
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Deploy Static Files
        run: |
          sudo cp -r static/* /data/memoryx/static/
          sudo nginx -t && sudo systemctl reload nginx
          echo "âœ… Static files deployed"

  # æ–¹æ¡ˆ 2: è§¦å‘ Webhookï¼ˆæœåŠ¡å™¨ç›‘å¬å¹¶æ‹‰å–ï¼‰
  trigger-webhook:
    name: Trigger Deployment Webhook
    runs-on: ubuntu-latest
    steps:
      - name: Trigger deployment webhook
        run: |
          # å‘é€ webhook åˆ°å…¬ç½‘ä¸­è½¬æœåŠ¡ï¼Œç”±å†…ç½‘æœåŠ¡å™¨è®¢é˜…
          # éœ€è¦é…ç½® webhook æœåŠ¡å¦‚ https://github.com/adnanh/webhook
          # æˆ–ä½¿ç”¨ https://smee.io ç­‰å·¥å…·
          echo "âš ï¸ Webhook deployment not configured"
          echo ""
          echo "To enable automatic deployment:"
          echo "1. Set up webhook listener on 31.65/31.66"
          echo "2. Configure WEBHOOK_URL secret"
          echo "3. Uncomment the curl command below"
          # curl -X POST "${{ secrets.WEBHOOK_URL }}" \
          #   -H "Authorization: Bearer ${{ secrets.WEBHOOK_SECRET }}" \
          #   -d '{"event": "static-update", "ref": "${{ github.sha }}"}'

  # æ–¹æ¡ˆ 3: æ‰“åŒ… Artifactï¼ˆæ‰‹åŠ¨ä¸‹è½½éƒ¨ç½²ï¼‰
  upload-artifact:
    name: Upload Static Artifact
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Create deployment package
        run: |
          mkdir -p deploy
          cp -r static/* deploy/
          tar -czf static-files.tar.gz -C deploy .
          ls -la static-files.tar.gz
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: static-files
          path: static-files.tar.gz
          retention-days: 7
      
      - name: Deployment instructions
        run: |
          echo ""
          echo "========================================="
          echo "ğŸ“¦ Static files packaged for deployment"
          echo "========================================="
          echo ""
          echo "Download from: https://github.com/t0ken-ai/MemoryX/actions/runs/${{ github.run_id }}"
          echo ""
          echo "Manual deployment steps:"
          echo "1. Download static-files.tar.gz"
          echo "2. SCP to 31.65: scp static-files.tar.gz deploy@192.168.31.65:/tmp/"
          echo "3. SSH and extract:"
          echo "   ssh deploy@192.168.31.65"
          echo "   sudo tar -xzf /tmp/static-files.tar.gz -C /data/memoryx/"
          echo "   sudo nginx -s reload"
          echo ""
