# Publish Python SDK to PyPI - 发布 MemoryX Python SDK 到 PyPI
#
# 用途：发布 MemoryX Python SDK 到 PyPI
#
# 触发条件：
#   - push tag sdk-python-v* (如 sdk-python-v1.0.0)
#   - workflow_dispatch 手动触发
#
# SDK 目录：sdk/python/
# 发布包名：t0ken-memoryx
# PyPI 地址：https://pypi.org/project/t0ken-memoryx/

name: Publish Python SDK to PyPI

on:
  push:
    tags:
      - 'sdk-python-v*'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: Check version and PyPI status
        id: check
        working-directory: sdk/python
        run: |
          LOCAL_VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT
          echo "=== Package version: $LOCAL_VERSION ==="
          
          echo "=== Checking PyPI ==="
          pip index versions t0ken-memoryx 2>/dev/null || echo "Package may not exist yet"
      
      - name: Build package
        working-directory: sdk/python
        run: |
          python -m build
          ls -la dist/
          twine check dist/*
      
      - name: Publish to PyPI
        working-directory: sdk/python
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          echo "=== Publishing ==="
          twine upload dist/* --verbose || echo "Upload failed - check token permissions"
