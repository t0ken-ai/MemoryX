# Webhook Deploy - 可重用的 Webhook 部署触发器
# 
# 用途：被其他工作流调用，触发服务器端的部署 webhook
# 调用方：build-api.yml
# 
# 输入参数：
#   - deploy_type: 部署类型 (alpha/release)
#   - image: Docker 镜像地址
#   - sha: Git commit SHA
#   - ref: Git ref
#   - update_celery: 是否同时更新 Celery Worker
#
# 服务器端处理：
#   - alpha → 31.66 测试环境
#   - release → 31.65 生产环境
#   - update_celery=true → 同时部署 Celery Worker

name: Webhook Deploy

on:
  workflow_call:
    inputs:
      deploy_type:
        description: 'Deployment type (alpha/release)'
        required: true
        type: string
      image:
        description: 'Docker image to deploy'
        required: false
        type: string
        default: ''
      sha:
        description: 'Git commit SHA'
        required: false
        type: string
        default: ''
      ref:
        description: 'Git ref'
        required: false
        type: string
        default: ''
      update_celery:
        description: 'Whether to update Celery worker'
        required: false
        type: boolean
        default: false

jobs:
  trigger:
    name: Trigger Webhook
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Deployment Webhook
        run: |
          DEPLOY_TYPE="${{ inputs.deploy_type }}"
          IMAGE="${{ inputs.image }}"
          UPDATE_CELERY="${{ inputs.update_celery }}"
          
          echo "=========================================="
          echo "Triggering deployment webhook"
          echo "Type: $DEPLOY_TYPE"
          echo "Image: ${IMAGE:-N/A}"
          echo "SHA: ${{ inputs.sha }}"
          echo "Update Celery: $UPDATE_CELERY"
          echo "=========================================="
          
          if [ -n "$IMAGE" ]; then
            curl -X POST "${{ secrets.DEPLOY_WEBHOOK_URL }}?token=${{ secrets.DEPLOY_KEY }}&type=$DEPLOY_TYPE" \
              -H "Content-Type: application/json" \
              -d '{
                "event": "${{ github.event_name }}",
                "repository": "${{ github.repository }}",
                "ref": "${{ inputs.ref }}",
                "sha": "${{ inputs.sha }}",
                "image": "'"$IMAGE"'",
                "update_celery": '"$UPDATE_CELERY"'
              }' \
              -w "\nHTTP Status: %{http_code}\n" \
              -s
          else
            curl -X POST "${{ secrets.DEPLOY_WEBHOOK_URL }}?token=${{ secrets.DEPLOY_KEY }}&type=$DEPLOY_TYPE" \
              -H "Content-Type: application/json" \
              -d '{
                "event": "${{ github.event_name }}",
                "repository": "${{ github.repository }}",
                "ref": "${{ inputs.ref }}",
                "sha": "${{ inputs.sha }}",
                "update_celery": '"$UPDATE_CELERY"'
              }' \
              -w "\nHTTP Status: %{http_code}\n" \
              -s
          fi
          
          echo ""
          echo "✅ Webhook triggered"