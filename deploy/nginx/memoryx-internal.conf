# 内网 Nginx 配置 (192.168.31.65:80)
# 作用：处理静态文件和路径路由
# 注意：SSL 在公网 nginx 终止，这里只处理 HTTP

server {
    listen 80;
    server_name _;  # 接受所有主机名

    # 日志
    access_log /var/log/nginx/memoryx-access.log;
    error_log /var/log/nginx/memoryx-error.log;

    # Gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

    # ==================== 官网首页 ====================
    location = / {
        root /data/memoryx/static;
        try_files /index.html =404;
    }

    # 隐私政策
    location = /privacy.html {
        root /data/memoryx/static;
        try_files /privacy.html =404;
    }

    # ==================== Portal SPA ====================
    # Portal 路径 - 所有路由指向 index.html (SPA 支持)
    location /portal {
        alias /data/memoryx/static/portal;
        try_files $uri $uri/ /index.html;
        index index.html;
        
        # 缓存静态资源
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
    }

    # ==================== 静态资源 ====================
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        root /data/memoryx/static;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # ==================== 健康检查 ====================
    location /nginx-health {
        access_log off;
        return 200 "nginx ok\n";
        add_header Content-Type text/plain;
    }

    # ==================== 禁止访问的文件 ====================
    location ~ /\. {
        deny all;
        return 404;
    }
}
