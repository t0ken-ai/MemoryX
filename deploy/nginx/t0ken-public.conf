# 公网 Nginx 配置 - 支持多服务器部署 + GitHub IP 限制

# GitHub Webhook/Actions IP 范围
# 来源: https://api.github.com/meta
geo $github_ip {
    default 0;
    # GitHub Webhook IPs
    192.30.252.0/22 1;
    185.199.108.0/22 1;
    140.82.112.0/20 1;
    143.55.64.0/20 1;
    # GitHub Actions (部分主要 IPs)
    4.148.0.0/16 1;
    4.149.0.0/16 1;
    4.150.0.0/16 1;
    4.151.0.0/16 1;
    4.152.0.0/16 1;
    4.153.0.0/16 1;
    4.154.0.0/16 1;
    4.155.0.0/16 1;
    4.156.0.0/16 1;
    4.157.0.0/16 1;
    4.158.0.0/16 1;
    4.159.0.0/16 1;
    4.160.0.0/16 1;
    4.161.0.0/16 1;
    4.162.0.0/16 1;
    4.163.0.0/16 1;
    4.164.0.0/16 1;
    4.165.0.0/16 1;
    4.166.0.0/16 1;
    4.167.0.0/16 1;
    4.168.0.0/16 1;
    4.169.0.0/16 1;
    4.170.0.0/16 1;
    4.171.0.0/16 1;
    4.172.0.0/16 1;
    4.173.0.0/16 1;
    4.174.0.0/16 1;
    4.175.0.0/16 1;
    20.33.0.0/16 1;
    20.34.0.0/16 1;
    20.37.128.0/17 1;
    20.38.0.0/16 1;
    20.39.0.0/16 1;
    20.41.0.0/16 1;
    20.42.0.0/16 1;
    20.43.0.0/16 1;
    20.44.0.0/16 1;
    20.45.0.0/16 1;
    20.46.0.0/16 1;
    20.47.0.0/16 1;
    20.48.0.0/16 1;
    20.49.0.0/16 1;
    20.50.0.0/16 1;
    20.51.0.0/16 1;
    20.52.0.0/16 1;
    20.53.0.0/16 1;
    20.54.0.0/16 1;
    20.55.0.0/16 1;
    20.56.0.0/16 1;
    20.57.0.0/16 1;
    20.58.0.0/16 1;
    20.59.0.0/16 1;
    20.60.0.0/16 1;
    20.61.0.0/16 1;
    20.62.0.0/16 1;
    20.190.128.0/18 1;
    20.191.0.0/18 1;
    40.64.0.0/16 1;
    40.65.0.0/16 1;
    40.66.0.0/16 1;
    40.67.0.0/16 1;
    40.68.0.0/16 1;
    40.69.0.0/16 1;
    40.70.0.0/16 1;
    40.71.0.0/16 1;
    40.72.0.0/16 1;
    40.73.0.0/16 1;
    40.74.0.0/16 1;
    40.75.0.0/16 1;
    40.76.0.0/16 1;
    40.77.0.0/16 1;
    40.78.0.0/16 1;
    40.79.0.0/16 1;
    40.80.0.0/16 1;
    40.81.0.0/16 1;
    40.82.0.0/16 1;
    40.83.0.0/16 1;
    40.84.0.0/16 1;
    40.85.0.0/16 1;
    40.86.0.0/16 1;
    40.87.0.0/16 1;
    40.88.0.0/16 1;
    40.89.0.0/16 1;
    40.90.0.0/16 1;
    40.91.0.0/16 1;
    40.92.0.0/16 1;
    40.93.0.0/16 1;
    40.94.0.0/16 1;
    40.95.0.0/16 1;
    40.96.0.0/16 1;
    40.97.0.0/16 1;
    40.98.0.0/16 1;
    40.99.0.0/16 1;
    40.100.0.0/16 1;
    40.101.0.0/16 1;
    40.102.0.0/16 1;
    40.103.0.0/16 1;
    40.104.0.0/16 1;
    40.105.0.0/16 1;
    40.106.0.0/16 1;
    40.107.0.0/16 1;
    40.108.0.0/16 1;
    40.109.0.0/16 1;
    40.110.0.0/16 1;
    40.111.0.0/16 1;
    40.112.0.0/16 1;
    40.113.0.0/16 1;
    40.114.0.0/16 1;
    40.115.0.0/16 1;
    40.116.0.0/16 1;
    40.117.0.0/16 1;
    40.118.0.0/16 1;
    40.119.0.0/16 1;
    40.120.0.0/16 1;
    40.121.0.0/16 1;
    40.122.0.0/16 1;
    40.123.0.0/16 1;
    40.124.0.0/16 1;
    40.125.0.0/16 1;
    40.126.0.0/16 1;
    40.127.0.0/16 1;
}

# 根据 tupe 参数映射到不同的后端
map $arg_tupe $deploy_backend {
    default     192.168.31.65:9000;
    "alpha"     192.168.31.66:9000;
    "release"   192.168.31.65:9000;
}

# HTTP 重定向到 HTTPS
server {
    listen 80;
    server_name t0ken.ai;
    return 301 https://$server_name$request_uri;
}

# HTTPS 主配置
server {
    listen 443 ssl http2;
    server_name t0ken.ai;

    # SSL 证书
    ssl_certificate /etc/nginx/ssl/t0ken.ai.crt;
    ssl_certificate_key /etc/nginx/ssl/t0ken.ai.key;
    ssl_protocols TLSv1.2 TLSv1.3;

    # 日志
    access_log /var/log/nginx/t0ken-access.log;
    error_log /var/log/nginx/t0ken-error.log;

    # ==================== API (31.65) ====================
    location /api/ {
        proxy_pass http://192.168.31.65:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    location /api/docs {
        proxy_pass http://192.168.31.65:8000/api/docs;
        proxy_set_header Host $host;
    }

    # ==================== Portal 和官网 (31.65) ====================
    location /portal {
        proxy_pass http://192.168.31.65:80;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location / {
        proxy_pass http://192.168.31.65:80;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ==================== Webhook 部署 (GitHub IP 限制) ====================
    location /deploy {
        # 只允许 GitHub IP 访问
        if ($github_ip = 0) {
            return 403 "Forbidden: Not a GitHub IP address";
        }

        # 使用 map 根据 tupe 参数选择后端
        proxy_pass http://$deploy_backend;
        
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 增加超时时间
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
        proxy_send_timeout 300s;
        
        # 日志
        access_log /var/log/nginx/deploy-access.log;
    }

    # ==================== 健康检查 ====================
    location /health {
        access_log off;
        proxy_pass http://192.168.31.65:8000/health;
    }
}
