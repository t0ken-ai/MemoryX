<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemoryX - Magic Link Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>body{font-family:'Inter',sans-serif;background:#0a0a0f}
    .fade-in{animation:fadeIn 0.3s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    </style>
</head>
<body class="text-slate-300">
    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-slate-900 border border-slate-800 rounded-xl p-8 w-full max-w-md fade-in">
            <!-- Logo -->
            <div class="text-center mb-8">
                <div class="flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="brain" class="w-10 h-10 text-purple-400"></i>
                </div>
                <h2 class="text-xl font-bold text-white" id="authTitle">Welcome to MemoryX</h2>
                <p class="text-sm text-slate-500 mt-1" id="authSubtitle">Sign in with your email</p>
            </div>

            <!-- Step 1: Email Input -->
            <div id="stepEmail" class="fade-in">
                <form id="emailForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-2">Email Address</label>
                        <input type="email" id="emailInput" required 
                            class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-indigo-500 transition-colors" 
                            placeholder="you@example.com"
                            autocomplete="email">
                        <p id="emailError" class="text-red-400 text-xs mt-2 hidden"></p>
                    </div>
                    
                    <div id="emailHint" class="text-xs text-slate-500 bg-slate-800/50 p-3 rounded-lg">
                        <i data-lucide="mail" class="w-4 h-4 inline mr-1"></i>
                        We'll send you a magic link to sign in instantly. No password needed!
                    </div>
                    
                    <button type="submit" id="emailSubmitBtn" 
                        class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-700 disabled:cursor-not-allowed text-white rounded-lg font-medium transition-all flex items-center justify-center gap-2">
                        <span id="btnText">Send Magic Link</span>
                        <svg id="btnSpinner" class="animate-spin hidden w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </form>
                
                <p class="text-xs text-slate-600 text-center mt-6">
                    By continuing, you agree to our <a href="#" class="text-slate-500 hover:text-slate-400">Terms</a>
                    and <a href="#" class="text-slate-500 hover:text-slate-400">Privacy Policy</a>
                </p>
            </div>

            <!-- Step 2: Check Email -->
            <div id="stepCheckEmail" class="hidden text-center fade-in">
                <div class="w-16 h-16 rounded-full bg-indigo-500/20 flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="mail-check" class="w-8 h-8 text-indigo-400"></i>
                </div>
                
                <h3 class="text-lg font-semibold text-white mb-2">Check your email</h3>
                
                <p class="text-slate-400 mb-4">
                    We've sent a magic link to<br>
                    <span id="sentEmail" class="text-white font-medium"></span>
                </p>
                
                <div class="bg-slate-800/50 rounded-lg p-4 mb-6 text-left">
                    <p class="text-sm text-slate-400 mb-2"><strong class="text-slate-300">What's next?</strong></p>
                    <ul class="text-sm text-slate-500 space-y-1">
                        <li>1. Open your email inbox</li>
                        <li>2. Click the <strong class="text-indigo-400">"Sign in to MemoryX"</strong> button</li>
                        <li>3. You'll be logged in automatically</li>
                    </ul>
                </div>
                
                <div class="space-y-3">
                    <button onclick="resendLink()" id="resendBtn" 
                        class="text-sm text-indigo-400 hover:text-indigo-300 disabled:text-slate-600">
                        Didn't receive it? Resend
                    </button>
                    <span id="resendTimer" class="text-sm text-slate-500 hidden">(60s)</span>
                    <br>
                    
                    <button onclick="backToEmail()" class="text-sm text-slate-500 hover:text-slate-400">
                        ← Use a different email
                    </button>
                </div>
            </div>

            <!-- Step 3: Processing Login Link -->
            <div id="stepProcessing" class="hidden text-center fade-in">
                <div class="w-16 h-16 rounded-full bg-indigo-500/20 flex items-center justify-center mx-auto mb-6 animate-pulse">
                    <i data-lucide="loader-2" class="w-8 h-8 text-indigo-400 animate-spin"></i>
                </div>
                
                <h3 class="text-lg font-semibold text-white mb-2">Signing you in...</h3>
                <p class="text-slate-400">Please wait while we verify your magic link</p>
            </div>

            <!-- Error State -->
            <div id="stepError" class="hidden text-center fade-in">
                <div class="w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="alert-circle" class="w-8 h-8 text-red-400"></i>
                </div>
                
                <h3 class="text-lg font-semibold text-white mb-2">Something went wrong</h3>
                
                <p id="errorMessage" class="text-slate-400 mb-6">The link may have expired or is invalid.</p>
                
                <button onclick="backToEmail()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg">
                    Try Again
                </button>
            </div>

        </div>
    </div>

    <!-- Main App (hidden until login) -->
    <div id="mainApp" class="hidden flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-[#0f0f13] border-r border-slate-800 flex flex-col">
            <div class="p-4 border-b border-slate-800">
                <div class="flex items-center gap-2">
                    <i data-lucide="brain" class="w-7 h-7 text-purple-400"></i>
                    <span class="font-bold text-white">MemoryX</span>
                </div>
            </div>
            
            <nav class="flex-1 p-3 space-y-1">
                <p class="px-3 text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2 mt-4">Overview</p>
                <a href="#" onclick="showSection('dashboard')" class="nav-link active flex items-center gap-3 px-3 py-2 text-sm text-white bg-slate-800/80 rounded-lg font-medium" data-section="dashboard">
                    <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                    Dashboard
                </a>
                <a href="#" onclick="showSection('activity')" class="nav-link flex items-center gap-3 px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-slate-800/50 rounded-lg transition-colors" data-section="activity">
                    <i data-lucide="activity" class="w-4 h-4"></i>
                    Activity
                </a>
                <a href="#" onclick="showSection('agents')" class="nav-link flex items-center gap-3 px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-slate-800/50 rounded-lg transition-colors" data-section="agents">
                    <i data-lucide="bot" class="w-4 h-4"></i>
                    Agents
                    <span id="agentCount" class="ml-auto text-xs bg-green-500/20 text-green-400 px-2 py-0.5 rounded-full">0</span>
                </a>
                <a href="#" onclick="showSection('facts')" class="nav-link flex items-center gap-3 px-3 py-2 text-sm text-slate-400 hover:text-white hover:bg-slate-800/50 rounded-lg transition-colors" data-section="facts">
                    <i data-lucide="brain" class="w-4 h-4"></i>
                    Facts
                    <span id="factCount" class="ml-auto text-xs bg-indigo-500/20 text-indigo-400 px-2 py-0.5 rounded-full">0</span>
                </a>
                
                <p class="px-3 text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2 mt-6">Account</p>
                <a href="#" onclick="logout()" class="flex items-center gap-3 px-3 py-2 text-sm text-slate-400 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-colors">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    Logout
                </a>
            </nav>
            
            <div class="p-4 border-t border-slate-800">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-sm font-medium overflow-hidden" id="userAvatar">A</div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-white truncate" id="userDisplayName">-</p>
                        <p class="text-xs text-slate-500 truncate" id="userEmail">-</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-auto">
            <header class="sticky top-0 z-40 bg-[#0a0a0f]/80 backdrop-blur-md border-b border-slate-800 px-8 py-4">
                <div class="flex items-center justify-between">
                    <h1 class="text-xl font-semibold text-white" id="pageTitle">Dashboard</h1>
                    
                    <div class="flex items-center gap-4">
                        <button onclick="refreshData()" class="p-2 text-slate-400 hover:text-white transition-colors" title="Refresh">
                            <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                        </button>
                        <a href="https://docs.t0ken.ai" target="_blank" class="text-slate-400 hover:text-white transition-colors">
                            <i data-lucide="help-circle" class="w-5 h-5"></i>
                        </a>
                    </div>
                </div>
            </header>

            <div id="dashboardSection" class="p-8 section-content">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-slate-900/50 border border-slate-800 rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-10 h-10 rounded-lg bg-indigo-500/20 flex items-center justify-center">
                                <i data-lucide="brain" class="w-5 h-5 text-indigo-400"></i>
                            </div>
                        </div>
                        <p class="text-2xl font-bold text-white" id="statFacts">0</p>
                        <p class="text-sm text-slate-500">Total Facts</p>
                    </div>

                    <div class="bg-slate-900/50 border border-slate-800 rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center">
                                <i data-lucide="bot" class="w-5 h-5 text-green-400"></i>
                            </div>
                        </div>
                        <p class="text-2xl font-bold text-white" id="statAgents">0</p>
                        <p class="text-sm text-slate-500">Agents</p>
                    </div>

                    <div class="bg-slate-900/50 border border-slate-800 rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center">
                                <i data-lucide="folder" class="w-5 h-5 text-blue-400"></i>
                            </div>
                        </div>
                        <p class="text-2xl font-bold text-white" id="statProjects">0</p>
                        <p class="text-sm text-slate-500">Projects</p>
                    </div>
                </div>

                <div class="bg-slate-900/50 border border-slate-800 rounded-xl p-6 mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="font-semibold text-white">Subscription & Usage</h2>
                        <span id="subscriptionTier" class="px-3 py-1 bg-slate-700 text-slate-300 rounded-full text-xs font-medium">FREE</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <p class="text-sm text-slate-500 mb-2">Cloud Search (Today)</p>
                            <div class="flex items-center gap-3">
                                <div class="flex-1 bg-slate-800 rounded-full h-2">
                                    <div id="searchUsageBar" class="bg-indigo-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                                <span id="searchUsageText" class="text-sm text-slate-400">0 / 100</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-end">
                            <button id="upgradeBtn" onclick="showUpgradeModal()" class="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white rounded-lg text-sm font-medium transition-all">
                                Upgrade to Pro - $9.9/mo
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-900/50 border border-slate-800 rounded-xl p-6 mb-8">
                    <h2 class="font-semibold text-white mb-4">Quick Actions</h2>
                    <div class="flex flex-wrap gap-4">
                        <button onclick="claimAgent()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Claim Agent
                        </button>
                        <button onclick="window.open('/agent-register-guide.html', '_blank')" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                            <i data-lucide="book-open" class="w-4 h-4"></i>
                            Register New Agent
                        </button>
                    </div>
                </div>

                <div class="bg-slate-900/50 border border-slate-800 rounded-xl">
                    <div class="px-6 py-4 border-b border-slate-800 flex items-center justify-between">
                        <h2 class="font-semibold text-white">Recent Activity</h2>
                    </div>
                    <div id="recentActivityList" class="divide-y divide-slate-800">
                        <div class="p-6 text-center text-slate-500">Loading...</div>
                    </div>
                </div>
            </div>

            <div id="agentsSection" class="hidden p-8 section-content">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-white">Agents</h2>
                    <div class="flex gap-3">
                        <button onclick="claimAgent()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm font-medium flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>Claim Agent
                        </button>
                        <button onclick="window.open('/agent-register-guide.html', '_blank')" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg text-sm font-medium flex items-center gap-2">
                            <i data-lucide="book-open" class="w-4 h-4"></i>Register New
                        </button>
                    </div>
                </div>

                <div class="bg-slate-900/50 border border-slate-800 rounded-xl">
                    <div id="agentsList" class="divide-y divide-slate-800">
                        <div class="p-6 text-center text-slate-500">Loading agents...</div>
                    </div>
                </div>
            </div>

            <div id="factsSection" class="hidden p-8 section-content">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-white">Facts</h2>
                    <div class="flex items-center gap-3">
                        <select id="factsDaysFilter" onchange="onFactsDaysFilterChange()" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-indigo-500">
                            <option value="">All Time</option>
                            <option value="1">Last 1 Day</option>
                            <option value="7">Last 7 Days</option>
                            <option value="14">Last 14 Days</option>
                            <option value="30">Last 30 Days</option>
                            <option value="custom">Custom Range</option>
                        </select>
                        <div id="factsCustomDateRange" class="hidden flex items-center gap-2">
                            <input type="date" id="factsStartDate" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-indigo-500">
                            <span class="text-slate-500">to</span>
                            <input type="date" id="factsEndDate" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-indigo-500">
                            <button onclick="loadFactsData()" class="px-3 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm">Apply</button>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-900/50 border border-slate-800 rounded-xl">
                    <div id="factsList" class="divide-y divide-slate-800">
                        <div class="p-6 text-center text-slate-500">Loading facts...</div>
                    </div>
                </div>
                
                <div id="factsPagination" class="flex items-center justify-between mt-4 px-4">
                    <p class="text-sm text-slate-500">Showing <span id="factsShowing">0</span> of <span id="factsTotal">0</span> facts</p>
                    <div class="flex items-center gap-2">
                        <button onclick="factsPrevPage()" id="factsPrevBtn" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 text-white rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                        <span id="factsPageInfo" class="text-sm text-slate-500">Page 1</span>
                        <button onclick="factsNextPage()" id="factsNextBtn" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 text-white rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                    </div>
                </div>
            </div>

            <div id="activitySection" class="hidden p-8 section-content">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-white">Activity</h2>
                    <div class="flex items-center gap-3">
                        <select id="activityAgentFilter" onchange="loadActivityData()" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-indigo-500">
                            <option value="">All Agents</option>
                        </select>
                        <select id="activityDaysFilter" onchange="onDaysFilterChange()" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-indigo-500">
                            <option value="">All Time</option>
                            <option value="1">Last 1 Day</option>
                            <option value="7">Last 7 Days</option>
                            <option value="14">Last 14 Days</option>
                            <option value="30">Last 30 Days</option>
                            <option value="custom">Custom Range</option>
                        </select>
                        <div id="customDateRange" class="hidden flex items-center gap-2">
                            <input type="date" id="activityStartDate" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-indigo-500">
                            <span class="text-slate-500">to</span>
                            <input type="date" id="activityEndDate" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-indigo-500">
                            <button onclick="loadActivityData()" class="px-3 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm">Apply</button>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-900/50 border border-slate-800 rounded-xl">
                    <div id="activityFullList" class="divide-y divide-slate-800">
                        <div class="p-6 text-center text-slate-500">Loading activity...</div>
                    </div>
                </div>
                
                <div id="activityPagination" class="flex items-center justify-between mt-4 px-4">
                    <p class="text-sm text-slate-500">Showing <span id="activityShowing">0</span> of <span id="activityTotal">0</span> activities</p>
                    <div class="flex items-center gap-2">
                        <button onclick="activityPrevPage()" id="activityPrevBtn" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 text-white rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                        <span id="activityPageInfo" class="text-sm text-slate-500">Page 1</span>
                        <button onclick="activityNextPage()" id="activityNextBtn" class="px-3 py-1 bg-slate-800 hover:bg-slate-700 text-white rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden fixed bottom-4 right-4 bg-slate-800 border border-slate-700 text-white px-4 py-3 rounded-lg shadow-lg z-50 flex items-center gap-3">
        <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
        <span id="toastMessage">Success!</span>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { 
            getAuth, 
            sendSignInLinkToEmail, 
            isSignInWithEmailLink, 
            signInWithEmailLink,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDfVaaDxgLuBowP61mEDnyyT0hNEbQczvM",
            authDomain: "t0ken-b62d0.firebaseapp.com",
            projectId: "t0ken-b62d0",
            storageBucket: "t0ken-b62d0.firebasestorage.app",
            messagingSenderId: "63204978168",
            appId: "1:63204978168:web:e3293bfa89442cf3e0ba0d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Make auth available globally
        window.firebaseAuth = auth;
        window.firebaseSignOut = signOut;

        // Check if user is already logged in
        onAuthStateChanged(auth, async (user) => {
            // Check if we have a token in localStorage
            const storedToken = localStorage.getItem('memoryx_token');
            if (storedToken) {
                showMainApp();
                loadDashboardData();
                return;
            }
            
            if (user) {
                // User is signed in, get ID token and login to our backend
                const idToken = await user.getIdToken();
                await loginToBackend(idToken, user.email);
            } else {
                // Check if this is a sign-in link
                if (isSignInWithEmailLink(auth, window.location.href)) {
                    showStep('stepProcessing');
                    
                    // Get email from localStorage
                    let email = localStorage.getItem('emailForSignIn');
                    
                    if (!email) {
                        // If email not in localStorage, show error
                        showStep('stepError');
                        document.getElementById('errorMessage').textContent = 'Please open the link on the same device where you requested it.';
                        return;
                    }
                    
                    try {
                        const result = await signInWithEmailLink(auth, email, window.location.href);
                        const idToken = await result.user.getIdToken();
                        await loginToBackend(idToken, result.user.email);
                        
                        // Clear email from storage
                        localStorage.removeItem('emailForSignIn');
                        
                        // Clear URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } catch (error) {
                        console.error('Sign in error:', error);
                        showStep('stepError');
                        document.getElementById('errorMessage').textContent = error.message;
                    }
                } else {
                    // Not logged in, show auth modal
                    showAuthModal();
                }
            }
        });

        // Send magic link
        window.sendMagicLink = async (email) => {
            const actionCodeSettings = {
                url: window.location.href,
                handleCodeInApp: true
            };
            
            await sendSignInLinkToEmail(auth, email, actionCodeSettings);
            
            // Save email for later
            localStorage.setItem('emailForSignIn', email);
        };

        // Login to our backend
        async function loginToBackend(idToken, email) {
            try {
                const response = await fetch('/api/auth/firebase', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('memoryx_token', data.access_token);
                    localStorage.setItem('memoryx_email', email);
                    // Store user info from backend response
                    if (data.user) {
                        localStorage.setItem('memoryx_display_name', data.user.display_name || '');
                        localStorage.setItem('memoryx_photo_url', data.user.photo_url || '');
                    }
                    showMainApp();
                    loadDashboardData();
                    showToast('Welcome!');
                } else {
                    throw new Error('Backend login failed');
                }
            } catch (error) {
                console.error('Backend login error:', error);
                await signOut(auth);
                showStep('stepError');
                document.getElementById('errorMessage').textContent = 'Login failed. Please try again.';
            }
        }

        // Logout
        window.firebaseLogout = async () => {
            await signOut(auth);
            localStorage.removeItem('memoryx_token');
            localStorage.removeItem('memoryx_email');
            localStorage.removeItem('memoryx_display_name');
            localStorage.removeItem('memoryx_photo_url');
            localStorage.removeItem('emailForSignIn');
        };
    </script>

    <script>
        const API_BASE = '/api';
        let authToken = localStorage.getItem('memoryx_token');
        let resendTimer = null;

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setupEmailForm();
            checkPaymentStatus();
            checkClaimAgent();
        });

        function checkPaymentStatus() {
            const params = new URLSearchParams(window.location.search);
            const payment = params.get('payment');
            if (payment === 'success') {
                showToast('Payment successful! You are now a PRO member.', 'success');
                window.history.replaceState({}, '', window.location.pathname);
            } else if (payment === 'canceled') {
                showToast('Payment was canceled.', 'error');
                window.history.replaceState({}, '', window.location.pathname);
            }
        }

        function checkClaimAgent() {
            const params = new URLSearchParams(window.location.search);
            const claimKey = params.get('claim');
            if (claimKey) {
                localStorage.setItem('memoryx_claim_key', claimKey);
            }
        }

        async function autoClaimAgent() {
            const claimKey = localStorage.getItem('memoryx_claim_key');
            if (!claimKey) return;
            
            try {
                const result = await apiRequest('/admin/agents/claim', {
                    method: 'POST',
                    body: JSON.stringify({ api_key: claimKey })
                });
                
                if (result.success) {
                    showToast('Agent linked to your account!', 'success');
                }
                localStorage.removeItem('memoryx_claim_key');
                window.history.replaceState({}, '', window.location.pathname);
            } catch (error) {
                console.error('Auto claim failed:', error);
            }
        }

        // Email form handler
        function setupEmailForm() {
            document.getElementById('emailForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('emailInput').value.trim();
                const btn = document.getElementById('emailSubmitBtn');
                const btnText = document.getElementById('btnText');
                const btnSpinner = document.getElementById('btnSpinner');
                const errorEl = document.getElementById('emailError');
                
                // Validate email
                if (!isValidEmail(email)) {
                    errorEl.textContent = 'Please enter a valid email address';
                    errorEl.classList.remove('hidden');
                    return;
                }
                
                errorEl.classList.add('hidden');
                
                // Show loading
                btn.disabled = true;
                btnText.textContent = 'Sending...';
                btnSpinner.classList.remove('hidden');
                
                try {
                    await window.sendMagicLink(email);
                    
                    document.getElementById('sentEmail').textContent = email;
                    showStep('stepCheckEmail');
                    startResendTimer(60);
                } catch (error) {
                    console.error('Error:', error);
                    errorEl.textContent = error.message || 'Failed to send magic link. Please try again.';
                    errorEl.classList.remove('hidden');
                } finally {
                    btn.disabled = false;
                    btnText.textContent = 'Send Magic Link';
                    btnSpinner.classList.add('hidden');
                }
            });
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        function showStep(stepId) {
            ['stepEmail', 'stepCheckEmail', 'stepProcessing', 'stepError'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(stepId).classList.remove('hidden');
        }

        function backToEmail() {
            showStep('stepEmail');
            document.getElementById('emailInput').value = '';
            if (resendTimer) clearInterval(resendTimer);
        }

        async function resendLink() {
            const email = document.getElementById('sentEmail').textContent;
            const btn = document.getElementById('resendBtn');
            
            btn.disabled = true;
            btn.textContent = 'Sending...';
            
            try {
                await window.sendMagicLink(email);
                startResendTimer(60);
                showToast('Magic link resent!');
            } catch (error) {
                showToast('Failed to resend. Please try again.', 'error');
                btn.disabled = false;
                btn.textContent = "Didn't receive it? Resend";
            }
        }

        function startResendTimer(seconds) {
            const btn = document.getElementById('resendBtn');
            const timerEl = document.getElementById('resendTimer');
            let remaining = seconds;
            
            btn.disabled = true;
            btn.textContent = "Didn't receive it?";
            timerEl.classList.remove('hidden');
            timerEl.textContent = `(${remaining}s)`;
            
            if (resendTimer) clearInterval(resendTimer);
            
            resendTimer = setInterval(() => {
                remaining--;
                timerEl.textContent = `(${remaining}s)`;
                
                if (remaining <= 0) {
                    clearInterval(resendTimer);
                    btn.disabled = false;
                    btn.textContent = "Didn't receive it? Resend";
                    timerEl.classList.add('hidden');
                }
            }, 1000);
        }

        function showAuthModal() {
            document.getElementById('authModal').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            showStep('stepEmail');
        }

        function showMainApp() {
            document.getElementById('authModal').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            loadUserInfo();
            autoClaimAgent();
            lucide.createIcons();
        }

        async function loadUserInfo() {
            try {
                const user = await apiRequest('/auth/me');
                const email = user.email || '';
                const displayName = user.display_name || '';
                const photoURL = user.photo_url || '';
                
                const displayText = displayName || email.split('@')[0] || 'User';
                document.getElementById('userDisplayName').textContent = displayText;
                document.getElementById('userEmail').textContent = email;
                
                const avatarEl = document.getElementById('userAvatar');
                if (photoURL) {
                    avatarEl.innerHTML = `<img src="${photoURL}" class="w-8 h-8 rounded-full object-cover" alt="${displayText}" onerror="this.parentElement.innerHTML='${displayText.charAt(0).toUpperCase()}'">`;
                } else {
                    avatarEl.textContent = displayText.charAt(0).toUpperCase();
                }
            } catch (error) {
                console.error('Failed to load user info:', error);
            }
        }

        async function logout() {
            await window.firebaseLogout();
            showAuthModal();
            backToEmail();
        }

        // Navigation
        function showSection(section) {
            document.querySelectorAll('.section-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-link').forEach(el => {
                el.classList.remove('active', 'text-white', 'bg-slate-800/80');
                el.classList.add('text-slate-400');
            });
            
            document.getElementById(section + 'Section').classList.remove('hidden');
            document.querySelector(`[data-section="${section}"]`).classList.add('active', 'text-white', 'bg-slate-800/80');
            document.querySelector(`[data-section="${section}"]`).classList.remove('text-slate-400');
            
            document.getElementById('pageTitle').textContent = section.charAt(0).toUpperCase() + section.slice(1);
            
            if (section === 'memories') loadMemories();
            if (section === 'apikeys') loadApiKeys();
            if (section === 'dashboard') loadDashboardData();
            if (section === 'agents') loadAgents();
            if (section === 'facts') { factsPage = 0; loadFacts(); }
            if (section === 'activity') { activityPage = 0; loadActivityAgents(); loadActivityData(); }
            
            lucide.createIcons();
        }

        // API Functions
        async function apiRequest(endpoint, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            const token = authToken || localStorage.getItem('memoryx_token');
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            console.log('API Request:', API_BASE + endpoint, 'Headers:', headers);

            const response = await fetch(`${API_BASE}${endpoint}`, {
                headers,
                ...options
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                const errorMsg = errorData.detail || errorData.message || `API error: ${response.status}`;
                throw new Error(errorMsg);
            }
            return response.json();
        }

        async function loadDashboardData() {
            try {
                const [stats, logs] = await Promise.all([
                    apiRequest('/admin/stats'),
                    apiRequest('/admin/logs?limit=8')
                ]);
                
                document.getElementById('statFacts').textContent = stats.data?.facts_count || 0;
                document.getElementById('statAgents').textContent = stats.data?.agents_count || 0;
                document.getElementById('statProjects').textContent = stats.data?.projects_count || 0;
                document.getElementById('factCount').textContent = stats.data?.facts_count || 0;
                document.getElementById('agentCount').textContent = stats.data?.agents_count || 0;
                
                const tier = stats.data?.subscription?.tier || 'free';
                const tierEl = document.getElementById('subscriptionTier');
                const upgradeBtn = document.getElementById('upgradeBtn');
                
                if (tier === 'pro') {
                    tierEl.textContent = 'PRO';
                    tierEl.className = 'px-3 py-1 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-full text-xs font-medium';
                    upgradeBtn.textContent = 'Manage Subscription';
                    upgradeBtn.onclick = manageSubscription;
                    upgradeBtn.style.display = 'block';
                } else {
                    tierEl.textContent = 'FREE';
                    tierEl.className = 'px-3 py-1 bg-slate-700 text-slate-300 rounded-full text-xs font-medium';
                    upgradeBtn.textContent = 'Upgrade to Pro - $9.9/mo';
                    upgradeBtn.onclick = showUpgradeModal;
                    upgradeBtn.style.display = 'block';
                }
                
                const quota = stats.data?.quota?.cloud_search;
                if (quota) {
                    const used = quota.used || 0;
                    const limit = quota.limit === -1 ? '∞' : quota.limit;
                    const percent = quota.limit === -1 ? 0 : Math.min(100, (used / quota.limit) * 100);
                    
                    document.getElementById('searchUsageBar').style.width = percent + '%';
                    document.getElementById('searchUsageText').textContent = quota.limit === -1 
                        ? `${used} (Unlimited)` 
                        : `${used} / ${limit}`;
                }
                
                renderRecentActivity(logs.data || []);
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }

        function renderRecentActivity(logs) {
            const container = document.getElementById('recentActivityList');
            if (!logs || logs.length === 0) {
                container.innerHTML = '<div class="p-6 text-center text-slate-500">No recent activity</div>';
                return;
            }
            
            container.innerHTML = logs.map(l => {
                const opTypeBadge = {
                    'add': '<span class="text-xs px-2 py-0.5 bg-green-500/20 text-green-400 rounded">ADD</span>',
                    'update': '<span class="text-xs px-2 py-0.5 bg-yellow-500/20 text-yellow-400 rounded">UPDATE</span>',
                    'delete': '<span class="text-xs px-2 py-0.5 bg-red-500/20 text-red-400 rounded">DELETE</span>'
                };
                
                const opBadges = (l.op_types || []).map(t => opTypeBadge[t] || '').join(' ');
                const factsText = (l.facts_content || []).slice(0, 2).join('; ');
                
                return `
                <div class="px-6 py-4 flex items-start gap-4">
                    <div class="w-10 h-10 rounded-lg bg-indigo-500/20 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="activity" class="w-5 h-5 text-indigo-400"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-sm font-medium text-white">${escapeHtml(l.agent_name || 'Unknown')}</span>
                            ${opBadges}
                        </div>
                        <p class="text-sm text-slate-400 truncate">${escapeHtml(factsText || l.input_content || '-')}</p>
                        ${l.reasoning ? `<details class="mt-1"><summary class="text-xs text-slate-500 cursor-pointer hover:text-slate-400 truncate">Show Reasoning</summary><p class="text-xs text-slate-500 mt-1 whitespace-pre-wrap">${escapeHtml(l.reasoning)}</p></details>` : ''}
                        <p class="text-xs text-slate-600 mt-1">${formatDate(l.created_at)}</p>
                    </div>
                </div>
            `}).join('');
            lucide.createIcons();
        }

        function renderRecentMemories(memories) {
            renderRecentActivity(memories);
        }

        let activityPage = 0;
        const activityPageSize = 10;
        
        function onDaysFilterChange() {
            const daysFilter = document.getElementById('activityDaysFilter').value;
            const customRange = document.getElementById('customDateRange');
            
            if (daysFilter === 'custom') {
                customRange.classList.remove('hidden');
            } else {
                customRange.classList.add('hidden');
            }
            loadActivityData();
        }
        
        async function loadActivityAgents() {
            try {
                const data = await apiRequest('/admin/agents');
                const select = document.getElementById('activityAgentFilter');
                select.innerHTML = '<option value="">All Agents</option>';
                (data.data || []).forEach(agent => {
                    select.innerHTML += `<option value="${agent.id}">${escapeHtml(agent.name)}</option>`;
                });
            } catch (error) {
                console.error('Failed to load agents:', error);
            }
        }
        
        async function loadActivityData() {
            const daysFilter = document.getElementById('activityDaysFilter').value;
            const agentFilter = document.getElementById('activityAgentFilter').value;
            
            let url = `/admin/logs?limit=${activityPageSize}&offset=${activityPage * activityPageSize}`;
            
            if (agentFilter) {
                url += `&agent_id=${agentFilter}`;
            }
            
            if (daysFilter && daysFilter !== 'custom') {
                url += `&days=${daysFilter}`;
            } else if (daysFilter === 'custom') {
                const startDate = document.getElementById('activityStartDate').value;
                const endDate = document.getElementById('activityEndDate').value;
                if (startDate) url += `&start_date=${startDate}`;
                if (endDate) url += `&end_date=${endDate}`;
            }
            
            try {
                const data = await apiRequest(url);
                renderActivityFullList(data.data || [], data.total || 0);
            } catch (error) {
                console.error('Failed to load activity:', error);
            }
        }
        
        function renderActivityFullList(logs, total) {
            const container = document.getElementById('activityFullList');
            if (!logs || logs.length === 0) {
                container.innerHTML = '<div class="p-6 text-center text-slate-500">No activity found</div>';
                document.getElementById('activityShowing').textContent = '0';
                document.getElementById('activityTotal').textContent = '0';
                return;
            }
            
            const start = activityPage * activityPageSize + 1;
            const end = Math.min(start + logs.length - 1, total);
            
            document.getElementById('activityShowing').textContent = `${start}-${end}`;
            document.getElementById('activityTotal').textContent = total;
            document.getElementById('activityPageInfo').textContent = `Page ${activityPage + 1}`;
            
            document.getElementById('activityPrevBtn').disabled = activityPage === 0;
            document.getElementById('activityNextBtn').disabled = end >= total;
            
            container.innerHTML = logs.map(l => {
                const opTypeBadge = {
                    'add': '<span class="text-xs px-2 py-0.5 bg-green-500/20 text-green-400 rounded">ADD</span>',
                    'update': '<span class="text-xs px-2 py-0.5 bg-yellow-500/20 text-yellow-400 rounded">UPDATE</span>',
                    'delete': '<span class="text-xs px-2 py-0.5 bg-red-500/20 text-red-400 rounded">DELETE</span>'
                };
                
                const opBadges = (l.op_types || []).map(t => opTypeBadge[t] || '').join(' ');
                const factsText = (l.facts_content || []).slice(0, 3).join('; ');
                
                return `
                <div class="px-6 py-4 flex items-start gap-4">
                    <div class="w-10 h-10 rounded-lg bg-indigo-500/20 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="activity" class="w-5 h-5 text-indigo-400"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-sm font-medium text-white">${escapeHtml(l.agent_name || 'Unknown')}</span>
                            ${opBadges || '<span class="text-xs px-2 py-0.5 bg-slate-700 text-slate-400 rounded">NONE</span>'}
                        </div>
                        <p class="text-sm text-slate-400">${escapeHtml(factsText || l.input_content || '-')}</p>
                        ${l.reasoning ? `<details class="mt-2"><summary class="text-xs text-slate-500 cursor-pointer hover:text-slate-400">Show Reasoning</summary><p class="text-xs text-slate-500 mt-1 whitespace-pre-wrap">${escapeHtml(l.reasoning)}</p></details>` : ''}
                        <p class="text-xs text-slate-600 mt-1">${formatDate(l.created_at)}</p>
                    </div>
                </div>
            `}).join('');
            lucide.createIcons();
        }
        
        function activityPrevPage() {
            if (activityPage > 0) {
                activityPage--;
                loadActivityData();
            }
        }
        
        function activityNextPage() {
            activityPage++;
            loadActivityData();
        }

        async function loadMemories() {
            await loadFacts();
        }

        function renderMemories(memories) {
            renderFacts(memories);
        }

        async function deleteMemory(id) {
            if (!confirm('Delete this memory?')) return;
            try {
                await apiRequest(`/admin/memories/${id}`, { method: 'DELETE' });
                showToast('Memory deleted');
                loadMemories();
                loadDashboardData();
            } catch (error) {
                showToast('Failed to delete', 'error');
            }
        }

        async function loadAgents() {
            try {
                const data = await apiRequest('/admin/agents');
                renderAgents(data.data || []);
            } catch (error) {
                console.error('Failed to load agents:', error);
            }
        }

        function renderAgents(keys) {
            const container = document.getElementById('agentsList');
            if (!keys || keys.length === 0) {
                container.innerHTML = '<div class="p-6 text-center text-slate-500">No agents. Create one via OpenClaw plugin or claim an existing agent.</div>';
                return;
            }
            
            container.innerHTML = keys.map(k => `
                <div class="px-6 py-4 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center">
                            <i data-lucide="bot" class="w-5 h-5 text-green-400"></i>
                        </div>
                        <div>
                            <p class="text-sm text-white font-medium">${escapeHtml(k.name)}</p>
                            <p class="text-xs text-slate-500 font-mono">${k.api_key ? k.api_key.substring(0, 12) + '...' + k.api_key.substring(k.api_key.length - 4) : '-'}</p>
                            <p class="text-xs text-slate-600">Created: ${formatDate(k.created_at)}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="copyToClipboard('${k.api_key || ''}')" class="text-slate-400 hover:text-white">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                        </button>
                        <button onclick="deleteAgent(${k.id})" class="text-slate-400 hover:text-red-400">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function claimAgent() {
            const apiKey = prompt('Enter your API Key to claim agent:', 'omx_...');
            if (!apiKey) return;

            try {
                console.log('Claiming agent with API key:', apiKey);
                console.log('Auth token:', authToken);
                const result = await apiRequest('/admin/agents/claim', {
                    method: 'POST',
                    body: JSON.stringify({ api_key: apiKey })
                });
                showToast(result.message || 'Agent claimed!');
                loadAgents();
                loadDashboardData();
            } catch (error) {
                console.error('Claim agent error:', error);
                showToast(error.message || 'Failed to claim agent', 'error');
            }
        }

        async function loadFacts() {
            loadFactsData();
        }

        let factsPage = 0;
        const factsPageSize = 10;
        
        function onFactsDaysFilterChange() {
            const daysFilter = document.getElementById('factsDaysFilter').value;
            const customRange = document.getElementById('factsCustomDateRange');
            
            if (daysFilter === 'custom') {
                customRange.classList.remove('hidden');
            } else {
                customRange.classList.add('hidden');
            }
            factsPage = 0;
            loadFactsData();
        }
        
        async function loadFactsData() {
            const daysFilter = document.getElementById('factsDaysFilter').value;
            
            let url = `/admin/facts?limit=${factsPageSize}&offset=${factsPage * factsPageSize}`;
            
            if (daysFilter && daysFilter !== 'custom') {
                url += `&days=${daysFilter}`;
            } else if (daysFilter === 'custom') {
                const startDate = document.getElementById('factsStartDate').value;
                const endDate = document.getElementById('factsEndDate').value;
                if (startDate) url += `&start_date=${startDate}`;
                if (endDate) url += `&end_date=${endDate}`;
            }
            
            try {
                const data = await apiRequest(url);
                renderFactsList(data.data || [], data.total || 0);
            } catch (error) {
                console.error('Failed to load facts:', error);
            }
        }
        
        function renderFactsList(facts, total) {
            const container = document.getElementById('factsList');
            if (!facts || facts.length === 0) {
                container.innerHTML = '<div class="p-6 text-center text-slate-500">No facts found.</div>';
                document.getElementById('factsShowing').textContent = '0';
                document.getElementById('factsTotal').textContent = '0';
                return;
            }
            
            const start = factsPage * factsPageSize + 1;
            const end = Math.min(start + facts.length - 1, total);
            
            document.getElementById('factsShowing').textContent = `${start}-${end}`;
            document.getElementById('factsTotal').textContent = total;
            document.getElementById('factsPageInfo').textContent = `Page ${factsPage + 1}`;
            
            document.getElementById('factsPrevBtn').disabled = factsPage === 0;
            document.getElementById('factsNextBtn').disabled = end >= total;
            
            container.innerHTML = facts.map(f => `
                <div class="px-6 py-4 flex items-start gap-4">
                    <div class="w-10 h-10 rounded-lg bg-indigo-500/20 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="brain" class="w-5 h-5 text-indigo-400"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm text-white">${escapeHtml(f.content)}</p>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs px-2 py-0.5 bg-slate-800 text-slate-400 rounded">${f.category || 'semantic'}</span>
                            <span class="text-xs text-slate-500">${formatDate(f.created_at)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }
        
        function factsPrevPage() {
            if (factsPage > 0) {
                factsPage--;
                loadFactsData();
            }
        }
        
        function factsNextPage() {
            factsPage++;
            loadFactsData();
        }

        function renderFacts(facts) {
            renderFactsList(facts, facts.length);
        }

        async function loadApiKeys() {
            await loadAgents();
        }

        function renderApiKeys(keys) {
            renderAgents(keys);
        }

        async function createApiKey() {
            await claimAgent();
        }

        async function deleteAgent(id) {
            if (!confirm('Delete this agent?')) return;
            try {
                await apiRequest(`/admin/agents/${id}`, { method: 'DELETE' });
                showToast('Agent deactivated');
                loadApiKeys();
                loadDashboardData();
            } catch (error) {
                showToast('Failed to delete', 'error');
            }
        }

        async function deleteApiKey(id) {
            deleteAgent(id);
        }

        function refreshData() {
            loadDashboardData();
            showToast('Data refreshed');
        }

        async function showUpgradeModal() {
            try {
                const response = await apiRequest('/subscription/create-checkout-session', { method: 'POST' });
                if (response.success && response.checkout_url) {
                    window.location.href = response.checkout_url;
                } else {
                    showToast('Failed to create checkout session', 'error');
                }
            } catch (error) {
                console.error('Checkout error:', error);
                showToast(error.message || 'Failed to start checkout', 'error');
            }
        }

        async function manageSubscription() {
            try {
                const response = await apiRequest('/subscription/create-portal-session', { method: 'POST' });
                if (response.success && response.portal_url) {
                    window.location.href = response.portal_url;
                } else {
                    showToast('Failed to open billing portal', 'error');
                }
            } catch (error) {
                console.error('Portal error:', error);
                showToast(error.message || 'Failed to open billing portal', 'error');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            showToast('Copied to clipboard');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
    </script>
</body>
</html>
